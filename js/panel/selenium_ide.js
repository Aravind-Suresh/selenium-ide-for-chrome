// Generated by CoffeeScript 1.6.2
(function() {
  "use strict";
  var SeleniumAjax, SeleniumIDE, SeleniumTest;

  this.SeleniumIDE = SeleniumIDE = (function() {
    function SeleniumIDE() {}

    SeleniumIDE.prototype.init = function(param) {
      if (param == null) {
        param = {};
      }
      this.ajax = new SeleniumAjax(param.server || 'http://localhost:9515');
      this.desiredCapabilities = param.desiredCapabilities || {};
      this.requiredCapabilities = param.requiredCapabilities || {};
      this.windowName = param.windowName || '';
      return this;
    };

    SeleniumIDE.prototype.getSessionId = function() {
      return this.ajax.post('/session', {
        'desiredCapabilities': this.desiredCapabilities,
        'requiredCapabilities': this.requiredCapabilities
      });
    };

    SeleniumIDE.prototype.setWindowName = function(name) {
      if (!name) {
        return;
      }
      return this.ajax.post('/session/:sessionId/window', {
        'name': name
      });
    };

    SeleniumIDE.prototype.setURL = function(url) {
      if (!url) {
        return;
      }
      return this.ajax.post('/session/:sessionId/url', {
        'url': url
      });
    };

    SeleniumIDE.prototype.send = function(param) {
      var _this = this;

      return this.getSessionId().next(function(data) {
        return _this.ajax.set('sessionId', data.sessionId);
      }).next(this.setWindowName.bind(this, this.windowName)).next(this.setURL.bind(this, param.baseURL)).next(this.executeText.bind(this, param.tests));
    };

    SeleniumIDE.prototype.getElementId = function() {};

    SeleniumIDE.prototype.executeText = function(tests) {
      var _this = this;

      return Deferred.loop(tests.length, function(i) {
        var test;

        test = new SeleniumTest(_this.ajax);
        return test.execute(tests[i]);
      });
    };

    SeleniumIDE.prototype.quit = function() {
      return this.ajax["delete"]('/session/:sessionId');
    };

    return SeleniumIDE;

  })();

  SeleniumTest = (function() {
    function SeleniumTest(ajax) {
      this.ajax = ajax;
    }

    SeleniumTest.prototype.execute = function(test) {
      return this.getElementId(test.selector).next(this.executeTarget.bind(this, test));
    };

    SeleniumTest.prototype.getElementId = function(selector) {
      return this.ajax.post('/session/:sessionId/element', {
        'using': 'css selector',
        'value': selector
      });
    };

    SeleniumTest.prototype.executeTarget = function(test, data) {
      var id;

      id = data.value.ELEMENT;
      if (test.name === 'click') {
        return this.clickElement(id);
      } else {
        return this.textElement(id, test.value);
      }
    };

    SeleniumTest.prototype.clickElement = function(elementId) {
      return this.ajax.post("/session/:sessionId/element/" + elementId + "/click");
    };

    SeleniumTest.prototype.textElement = function(elementId, value) {
      return this.ajax.post("/session/:sessionId/element/" + elementId + "/value", {
        'value': value.split(/(?:)/)
      });
    };

    return SeleniumTest;

  })();

  SeleniumAjax = (function() {
    function SeleniumAjax(server, param) {
      this.server = server;
      this.param = param != null ? param : {};
    }

    SeleniumAjax.prototype.set = function(key, val) {
      return this.param[key] = val;
    };

    SeleniumAjax.prototype.ajax = function(param) {
      var defer, xhr,
        _this = this;

      if (typeof param.data !== 'string') {
        param.data = JSON.stringify(param.data);
      }
      param.url = param.url.replace(/:(\w+)/g, function(all, name) {
        return _this.param[name];
      });
      defer = Deferred();
      xhr = new XMLHttpRequest();
      xhr.onreadystatechange = function() {
        if (xhr.readyState !== 4) {
          return;
        }
        if (xhr.status !== 200) {
          return;
        }
        return defer.call(JSON.parse(xhr.responseText));
      };
      xhr.open(param.method, this.server + param.url);
      xhr.send(param.data);
      return defer;
    };

    SeleniumAjax.prototype.post = function(url, param) {
      if (param == null) {
        param = '';
      }
      return this.ajax({
        'url': url,
        'data': param,
        'method': 'POST'
      });
    };

    SeleniumAjax.prototype.get = function(url) {
      return this.ajax({
        'url': url,
        'method': 'GET'
      });
    };

    SeleniumAjax.prototype["delete"] = function(url, param) {
      if (param == null) {
        param = '';
      }
      return this.ajax({
        'url': url,
        'data': param,
        'method': 'DELETE'
      });
    };

    return SeleniumAjax;

  })();

}).call(this);
